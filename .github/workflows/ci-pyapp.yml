# =============================================================================
# CI Pipeline â€” pyapp (Python)
# =============================================================================
# Workflow independiente para el proyecto Python. Solo se ejecuta cuando
# cambian archivos en pyapp/ (paths). Misma estructura: lint, unit, functional, quality gate.
# =============================================================================

name: CI (pyapp)

on:
  push:
    branches: [main, develop]
    paths: ['pyapp/**']
  pull_request:
    branches: [main, develop]
    paths: ['pyapp/**']

permissions:
  contents: read
  pull-requests: read

env:
  PYTHON_VERSION: ${{ vars.PYTHON_VERSION || '3.12' }}
  COVERAGE_MIN_PERCENT: ${{ vars.COVERAGE_MIN_PERCENT_PYAPP || vars.COVERAGE_MIN_PERCENT || '80' }}

jobs:
  setup:
    name: Checkout & Setup
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: pyapp
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ vars.PYTHON_VERSION || '3.12' }}
          cache: 'pip'
          cache-dependency-path: pyapp/pyproject.toml

      - name: Install dependencies
        run: pip install -e ".[dev]"

  lint:
    name: Lint
    runs-on: ubuntu-latest
    needs: setup
    defaults:
      run:
        working-directory: pyapp
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ vars.PYTHON_VERSION || '3.12' }}
          cache: 'pip'
          cache-dependency-path: pyapp/pyproject.toml

      - name: Install dependencies
        run: pip install -e ".[dev]"

      - name: Run Ruff
        run: ruff check .

  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: setup
    defaults:
      run:
        working-directory: pyapp
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ vars.PYTHON_VERSION || '3.12' }}
          cache: 'pip'
          cache-dependency-path: pyapp/pyproject.toml

      - name: Install dependencies
        run: pip install -e ".[dev]"

      - name: Run unit tests with coverage
        run: >
          pytest tests/unit -m unit
          --cov=src
          --cov-report=term-missing
          --cov-report=html
          --cov-fail-under=${{ env.COVERAGE_MIN_PERCENT }}

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: pyapp-coverage-${{ github.run_id }}
          path: pyapp/htmlcov/
          retention-days: 7

  functional-tests:
    name: Functional Tests
    runs-on: ubuntu-latest
    needs: setup
    defaults:
      run:
        working-directory: pyapp
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ vars.PYTHON_VERSION || '3.12' }}
          cache: 'pip'
          cache-dependency-path: pyapp/pyproject.toml

      - name: Install dependencies
        run: pip install -e ".[dev]"

      - name: Run functional tests
        run: pytest tests/functional -m functional

  quality-gate:
    name: Quality Gate
    runs-on: ubuntu-latest
    needs: [lint, unit-tests, functional-tests]
    steps:
      - run: |
          echo "All gates passed: Lint OK, Unit tests OK, Coverage OK, Functional tests OK."
          echo "CI (pyapp) is green."
